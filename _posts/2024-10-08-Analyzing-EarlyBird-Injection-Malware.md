---
title: "Analyzing EarlyBird Injection Malware"
date: 2024-10-08
---


### Preface
---

<div style="margin-top: 20px; margin-bottom: 40px;text-align: justify;">
	

In the ever-evolving landscape of cyber threats, the IcedID loader stands out as a formidable banking Trojan with sophisticated capabilities. Originally known for its role as a banking malware, IcedID has grown to serve as a versatile loader for deploying additional malicious payloads. This analysis delves into the intricate mechanisms of IcedID, from its initial delivery through phishing or exploit kits, to its operational intricacies and data exfiltration methods.

Key areas of focus include the loaderâ€™s evasion techniques, persistence strategies, and communication with command-and-control servers. By dissecting IcedID's functionality and evolution, this analysis aims to shed light on its impact on targeted systems and provide insights into effective detection and mitigation strategies.

</div>

### Basic Static Analysis
---

<div style="margin-top: 20px;"></div>

In this section I used a simple tool named `pe studio` and `floss` to get a general understanding of this sample.

<img src="https://b3rg01.github.io/MyBlog/docs/assets/Pasted image 20240716223035.png" style="margin-top: 20px; margin-bottom: 20px; margin-left: auto; margin-right: auto;box-shadow: 10px;border: 2px solid transparent; border-radius: 8px;" >

- We can see that this malware must be written in `C#`

<img src="https://b3rg01.github.io/MyBlog/docs/assets/Pasted image 20240716223435.png" style="margin-top: 20px; margin-bottom: 20px; margin-left: auto; margin-right: auto;box-shadow: 10px;border: 2px solid transparent; border-radius: 8px;" > 
- Passing the hash in Virus Total gives us a hit, so now we can definitely be sure that this sample is malicious

Image
Image

- Interesting strings, Before unpacking
<img src="https://b3rg01.github.io/MyBlog/docs/assets/Pasted image 20240721140409.png" style="margin-top: 20px; margin-bottom: 20px; margin-left: auto; margin-right: auto;box-shadow: 10px;display: block;border: 2px solid transparent; border-radius: 8px;" > 
- By going through the strings report generated by `floss` we can see that there some Windows API functions that will be loaded, this already seem fishy, but let's continue to see what else we can find

Image
Image

- We can also find an executable name in the strings output that match with what was returned by Virus Total
   
<div style="margin-bottom: 40px;"></div>

### Basic Dynamic Analysis
---




### Advanced Static Analysis
---

<div style="margin-top: 20px;"></div>

  > [!info] For this part I used `dnSpy` instead of `Ghidra` since it's a `C#` application

<img src="https://b3rg01.github.io/MyBlog/docs/assets/Pasted image 20240717081349.png" style="margin-top: 20px; margin-bottom: 20px; margin-left: auto; margin-right: auto;box-shadow: 10px;border: 2px solid transparent; border-radius: 8px;" > 

Image

  - In the main program function we can see that a resource his being loaded, so I will save the `png` file and try to open it to see what will happen.

<img src="https://b3rg01.github.io/MyBlog/docs/assets/Pasted image 20240717081349.png" style="margin: 20px;box-shadow: 10px;border: 2px solid transparent; border-radius: 8px;" > 

Image

- Another resource is being loaded in the program
  
<img src="https://b3rg01.github.io/MyBlog/docs/assets/Pasted image 20240717085042.png" style="margin-top: 20px; margin-bottom: 20px; margin-left: auto; margin-right: auto;box-shadow: 10px;border: 2px solid transparent; border-radius: 8px;" > 

- There's some `xor` being done with the image and the resource that was loaded earlier, we can guess that this operation is performed to decrypt the payload contained in the image
  
<img src="https://b3rg01.github.io/MyBlog/docs/assets/Pasted image 20240717085910.png" style="margin: 20px;box-shadow: 10px;border: 2px solid transparent; border-radius: 8px;" > 

  > [!info] We're going to run the debugger to see what is being loaded at the line 44


<img src="https://b3rg01.github.io/MyBlog/docs/assets/Pasted image 20240717090929.png" style="margin-top: 20px; margin-bottom: 20px; margin-left: auto; margin-right: auto;box-shadow: 10px;border: 2px solid transparent; border-radius: 8px;" > 
	
- After running the debugger, we can see that the variable contains an executable based on the first hex values which are `4D` and `5A`

  Image

- After dumping the executable in a separate file and opening it in `dnSpy` we can see the actually functionality of the malware
- we can also see that there's some anti sandbox detection, which is leading me to think that this program might just be the second stage which will lay the ground the work before running the shellcode

  Image

- There's also a resource called `Main`, we will dump it and analyze it later

IMAGE


- We can see that some registries are being created/modified

IMAGE

- The sample is also trying to disable `uac`

IMAGE
IMAGE
IMAGE

- Here we can see that the resource that was named `Main`, that we found earlier, is being decompressed and will be run

> [!info] We will now switch to `ghidra`, because the executable `main` does not seem to be written in `C#

IMAGE

- This is the output of the executable open in ghidra, now we'll try to find where exactly the apc injection happens.
- In the screenshot up ahead you should notice that named a function as `Very_Interesting_Underneath` and that is not because I did not know what to put, but before that let's go through some stuff before

IMAGE
IMAGE

- Notice how it gets called as a subroutine, now why would that be the case, honestly I don't

IMAAGE

- By going through the code I notice a function that perform the apc injection that we've been looking for, let's dive in to find out what it does

IMAGE

- Here we can see the `CreateProcessA` and if you pay attention you can spot a 4 for the 6 argument which represent the `Creation Flags` , so this process will be created in a `SUSPENDED STATE`
- For an `apc injection` to occur the process in question has to be in a suspended state


IMAGE

- the process info of the suspended process are then being used as an argument in the `NtQueueApcThread` and then being resumed as a normal execution flow and because the APC has been queued, the queued procedure will execute at some point when the thread enters an alertable state





<div style="margin-bottom: 40px;"></div>

### Advanced Dynamic Analysis
---

<div style="margin-top: 20px;"></div>



<div style="margin-bottom: 40px;"></div>

### Rules & Signatures
---

<div style="margin-top: 20px;"></div>

```
rule IcedId_Ldr_Detection {
    
    meta: 
        last_updated = "2024-07-21"
        author = "8erg"
        description = "Yara detection rule for IcedId Loader"

    strings:
        $magical_path = "c:\\Sizeanger\\CreatePick\\mixpractice\\Sciencescience\\KeyContain\\farterm\\Tiresubtract\\CenterSkinMass.pdb"

    condition:
        $magical_path
}

```

<div style="margin-bottom: 40px;"></div>

### Conclusion
---

<div style="margin-top: 20px; margin-bottom: 40px;text-align: justify;">
	
Well, this is it for this analysis. I really enjoyed this one! I'm really starting to get the hang of it. 
It's interesting to see how some people develop their malware, you can see that there's a lot of thought that are put into it. 
I'm really learning a lot. Well, I'll stop babbling now. See you on the next one!

</div>



